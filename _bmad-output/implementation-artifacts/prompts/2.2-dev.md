# Dev Prompt — Story 2.2 (Nginx reference edge config: `/media` auth_request + SigV4)

## Source of truth

- Story: `_bmad-output/implementation-artifacts/2-2-nginx-reference-edge-configuration-dev-prod-aligned-for-media-auth-request-sigv4-propagation.md`
- Sprint 0 order: `_bmad-output/planning-artifacts/development-order.md`
- Context / non-negotiables: `_bmad-output/project-context.md` (Docker-first; no-leak)
- Existing edge contract docs (Story 2.1): `docs/selfhost/edge-contract.md`
  - If not yet merged, consult PR #9 (`story/2.1-edge-contract-preflight`) for the
    latest wording; avoid duplicating the same docs in 2.2.

## Goal (Story 2.2)

Ship an **Nginx reference implementation** (dev + prod aligned) for the proxy-agnostic
`/media` edge contract:

- `/media/` and `/media/preview/` are protected by an **auth subrequest** to the
  backend media-auth endpoint.
- Nginx forwards all required **SigV4 headers** returned by the backend to the
  upstream S3 request.
- Logging is **no-leak by default** (do not log SigV4 secrets).

## Non-negotiables

- Nginx is **reference only**; docs must remain proxy-agnostic (no lock-in).
- No-leak: never echo/log SigV4 headers or signed URLs.
- Docker-first; do not remove or “improve” K8s/Helm.

## Known file locations

- Dev Nginx: `docker/files/development/etc/nginx/conf.d/default.conf`
- Prod Nginx: `docker/files/production/etc/nginx/conf.d/default.conf`
- Template: `src/nginx/servers.conf.erb`
- Backend endpoint: `GET /api/v1.0/items/media-auth/` (edge path typically `/media-auth`)

## Implementation tasks (expected)

1. Inventory and diff dev vs prod config at the contract level:
   - auth subrequest behavior (`auth_request`, forwarded `X-Original-URL`, no body)
   - header propagation to S3 upstream
   - path rewriting and host handling
2. Ensure SigV4 header propagation is complete:
   - Required: `Authorization`, `X-Amz-Date`, `X-Amz-Content-SHA256`
   - Optional but required when present: `X-Amz-Security-Token`
   - If additional `x-amz-*` headers are required by the backend in future, document
     how to add them explicitly (no wildcards).
3. No-leak logging defaults/guidance:
   - Ensure access/error logs do not include SigV4 secrets by default.
   - Provide a safe default (e.g. disable access logs for `/media*` locations) and
     document “do not add `$http_authorization` / `$upstream_http_authorization` to
     log formats”.
4. Docs alignment:
   - Keep the edge contract proxy-agnostic.
   - Nginx snippets/examples must match the docs.
5. Verification (dev-owned; record in run report):
   - `/media` download via Nginx (INTERNAL_PROXY) works.
   - `/media/preview` works where applicable.
   - SigV4 headers are forwarded (no 403 due to missing headers).

## CI / PR policy (this fork)

Do not wait for these non-blocking checks:

- Docker Hub Workflow / build-and-push-backend
- Docker Hub Workflow / build-and-push-frontend
- Update crowdin sources / synchronize-with-crowdin
- Frontend Workflow / test-e2e (chromium/firefox/webkit)

## Traceability (required)

- Create `_bmad-output/implementation-artifacts/runs/<YYYYMMDD-HHMMSS>-2.2/`
  with `report.md`, `commands.log`, `files-changed.txt`, `gates.md`
- Update `_bmad-output/implementation-artifacts/latest.txt`
- Update `_bmad-output/implementation-artifacts/sprint-status.yaml`
  (2.2: ready-for-dev → in-progress → review/done)
- Fill “Dev Agent Record” in the Story 2.2 file

