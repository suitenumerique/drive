# Dev Prompt — Story 11.2 (SeaweedFS baseline in Docker/compose)

## Source of truth

- Story: `_bmad-output/implementation-artifacts/11-2-encode-seaweedfs-as-the-blocking-baseline-profile-repeatable-checks-runbook-alignment.md`
- Sprint 0 order: `_bmad-output/planning-artifacts/development-order.md`
- Baseline context: `_bmad-output/project-context.md`

## Goal (Story 11.2)

Make **SeaweedFS S3 gateway** the **default** Docker Compose storage backend (baseline), and keep **MinIO** as an explicitly **non-blocking** fixture only.

## Non-negotiables (from PRD/Architecture/UX/Stories)

- Docker-first, minimal change set; do not delete existing K8s/Helm assets.
- No-leak: never put secrets/tokens in diffs, logs, or artifacts (redact when needed).
- Baseline promise: “blocking storage baseline” is SeaweedFS; MinIO may exist only as optional fixture.

## Blocking issue to fix (required for “done”)

Baseline `seaweedfs-s3` must accept **SigV4-signed** S3 requests from Drive/boto3 and `mc`.

If SeaweedFS S3 server has no configured access keys, signed requests will fail (e.g., `InvalidAccessKeyId` / “Signed request requires setting up SeaweedFS S3 authentication”).

## Official decision for Sprint 0 (no alternatives for this story)

Configure SeaweedFS S3 gateway auth via **environment variables on the `seaweedfs-s3` container**:

- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`

Do **not** introduce an IAM `config.json` + mount in this story (keep changes minimal and Docker-first). Advanced IAM config can be a later story if needed.

Drive client credentials remain in `env.d/development/common` as:

- `AWS_S3_ACCESS_KEY_ID`
- `AWS_S3_SECRET_ACCESS_KEY`

Use the same values in dev for repeatability (e.g., `drive` / `password`), consistent with existing fixture defaults.

## Required implementation changes

1. Create `env.d/development/seaweedfs-s3` with:
   - `AWS_ACCESS_KEY_ID=drive`
   - `AWS_SECRET_ACCESS_KEY=password`
2. Update `compose.yaml`:
   - Add `env_file: [env.d/development/seaweedfs-s3]` to the `seaweedfs-s3` service.
   - Keep SeaweedFS published on host `localhost:9000` and internal endpoint `http://seaweedfs-s3:8333`.
   - Keep MinIO available only under an explicit profile (non-baseline).

## Verification (must pass)

Baseline infra up:

- `docker compose -f compose.yaml up -d seaweedfs-s3 createbuckets`

Proof that **signed** S3 works (upload + stat):

- `docker run --rm --network drive_default --entrypoint /bin/sh minio/mc -c "mc alias set drive http://seaweedfs-s3:8333 drive password >/dev/null && mc mb -p drive/drive-media-storage || true && echo hello >/tmp/hello.txt && mc cp /tmp/hello.txt drive/drive-media-storage/hello.txt && mc stat drive/drive-media-storage/hello.txt"`

Bucket versioning enable (expected for future WOPI prereq story):

- `docker run --rm --network drive_default --entrypoint /bin/sh minio/mc -c "mc alias set drive http://seaweedfs-s3:8333 drive password >/dev/null && mc version enable drive/drive-media-storage"`

## Traceability (must be updated for this fix)

- Create a new run folder:
  - `_bmad-output/implementation-artifacts/runs/<YYYYMMDD-HHMMSS>-11.2/`
  - with `report.md`, `commands.log`, `files-changed.txt`, `gates.md`
- Update pointers:
  - `_bmad-output/implementation-artifacts/latest.txt` (relative path to the new run)
  - `_bmad-output/implementation-artifacts/sprint-status.yaml` (11.2 only “done” after verification passes)
  - Fill/adjust “Dev Agent Record” in the story file to reference the new run and the SigV4 fix.

## PR policy (strict)

- Create **one** PR for the story only (no separate “bugfix PR”): this SigV4 baseline fix is part of Story 11.2.
- Branch name: `story/11.2-seaweedfs-baseline`
- PR description must link:
  - the story file, and
  - the new run `report.md`.

