# Dev Prompt — Story 1.2 (split allowlists derived from `DRIVE_PUBLIC_URL`)

## Source of truth

- Story: `_bmad-output/implementation-artifacts/1-2-separate-allowlists-for-redirect-uris-vs-origins-hosts-derived-from-drive-public-url.md`
- Sprint 0 order: `_bmad-output/planning-artifacts/development-order.md`
- Context: `_bmad-output/project-context.md`
- Existing work to reuse:
  - `src/backend/core/utils/public_url.py` (canonical URL validation + TLS posture)
  - `src/backend/drive/settings.py` (`Base.post_setup` validation/preflight)
  - `docs/env.md`, `docs/failure-class-glossary.md`

## Goal (Story 1.2)

Introduce a **split allowlist model** for:

- **Redirect URIs** (absolute URIs incl. path) vs
- **Origins / hosts** (for host/origin checks where applicable),

with canonical defaults **derived from `DRIVE_PUBLIC_URL`** and **operator-provided additions** validated deterministically.

## Non-negotiables

- Docker-first, minimal changes.
- No-leak: validation errors must not echo sensitive values; provide deterministic `failure_class` + `next_action_hint`.
- HTTPS-only posture in production: reuse the **centralized TLS posture** introduced by Story 2.3.

## Official decisions for Story 1.2 (do not diverge)

1. `DRIVE_PUBLIC_URL` remains the canonical root; derived entries are always included.
2. In production posture (HTTPS-only), any configured **origin** must be `https://…`.
3. Redirect allowlists must be **absolute URIs** (scheme + host + path); no wildcards.
4. Backward compatibility: keep supporting legacy env vars (e.g. `OIDC_REDIRECT_ALLOWED_HOSTS`) by merging them deterministically with the new computed lists.

## Implementation tasks (expected)

1. Map existing consumers (quick, concrete)
   - Locate how `lasuite.oidc_login` uses `OIDC_REDIRECT_ALLOWED_HOSTS` and `OIDC_REDIRECT_REQUIRE_HTTPS`.
   - Identify where Drive uses:
     - `SDK_CORS_ALLOWED_ORIGINS` (SDK relay preflight),
     - `CORS_ALLOWED_ORIGINS` / `CSRF_TRUSTED_ORIGINS` (only adjust if clearly safe and expected).

2. Add new operator-facing settings (names to pick, but must be split by purpose)
   - Additional redirect URIs (absolute URIs with path).
   - Additional origins (origin form only; no path/query/fragment).
   - Additional hosts (hostnames only).

3. Implement deterministic validators/normalizers
   - Use `src/backend/core/utils/public_url.py` as the baseline:
     - Extend or add helpers for:
       - absolute redirect URI validation (path required/allowed; no query/fragment unless explicitly required),
       - origin validation (scheme+host(+port), no path/query/fragment),
       - host validation (hostname only; no wildcards).
   - Enforce TLS posture rules from Story 2.3.
   - Normalize and deduplicate deterministically.
   - Raise fail-fast errors in `Base.post_setup` with stable:
     - `failure_class=config.allowlist.<kind>.<reason>`
     - `next_action_hint=...`
   - Update `docs/failure-class-glossary.md` as needed.

4. Wire computed allowlists into settings
   - In `src/backend/drive/settings.py:Base.post_setup`:
     - Always include canonical values derived from `DRIVE_PUBLIC_URL`.
     - Merge operator additions + legacy vars deterministically.
     - Apply final lists to:
       - `OIDC_REDIRECT_ALLOWED_HOSTS` / `OIDC_REDIRECT_REQUIRE_HTTPS`
       - `SDK_CORS_ALLOWED_ORIGINS`
       - (Optional) `CORS_ALLOWED_ORIGINS` / `CSRF_TRUSTED_ORIGINS` only if confident.

5. Tests + docs
   - Unit tests for new validators.
   - Integration tests in `src/backend/core/tests/test_settings.py` verifying computed settings.
   - Update `docs/env.md` with the split model and examples.

## Verification (minimum)

- `make lint`
- `docker compose run --rm --no-deps app-dev pytest -q` (scope to new/updated tests at least)

## Traceability (required)

- New run report:
  - `_bmad-output/implementation-artifacts/runs/<YYYYMMDD-HHMMSS>-1.2/report.md`
  - plus `commands.log`, `files-changed.txt`, `gates.md`
- Update:
  - `_bmad-output/implementation-artifacts/latest.txt`
  - `_bmad-output/implementation-artifacts/sprint-status.yaml` (1.2 → review/done)
  - Dev Agent Record in the story file (link the run report)

