# Dev Prompt — Story 2.1 (Docker-first edge contract docs + config preflight validation + smoke checks)

## Source of truth

- Story: `_bmad-output/implementation-artifacts/2-1-docker-first-edge-contract-documentation-configuration-validation-smoke-checks.md`
- Sprint 0 order: `_bmad-output/planning-artifacts/development-order.md`
- Context + non-negotiables: `_bmad-output/project-context.md` (Docker-first; SeaweedFS baseline; no-leak)
- Architecture/PRD/UX references listed at bottom of the story file.
- Existing work to reuse:
  - `src/backend/core/management/commands/config_preflight.py`
  - `src/backend/core/tests/commands/test_config_preflight.py`
  - `src/backend/core/utils/public_url.py` (canonical URL validation + TLS posture)
  - `docs/failure-class-glossary.md`
  - Nginx reference only (do not hard-require Nginx):
    - `docker/files/**/nginx/conf.d/default.conf`

## Goal (Story 2.1)

Ship a **Docker-first v1 “edge contract”** that is:

- **Proxy-agnostic** (works behind any reverse proxy; Nginx is reference only),
- **Deterministic** (validation checks config values only; no runtime proxy inspection),
- **No-leak** (safe operator hints only; no secrets in errors/artifacts),
- **Audience-aware** (INTERNAL_PROXY vs EXTERNAL_BROWSER for media/S3 paths).

## Non-negotiables

- Docker-first baseline. **Do not remove or “improve” K8s/Helm**; they stay reference-only “as-is”.
- SeaweedFS is the compose baseline for S3 (already done in Story 11.2).
- Preflight must fail fast with deterministic `failure_class` + `next_action_hint`.
- CI constraints:
  - `CHANGELOG.md` must be modified (keep all lines < 80 chars).
  - Commit titles must match `<gitmoji>(<scope>) <subject>`; avoid non-gitmoji emojis.

## Official decisions for Story 2.1 (do not diverge)

1. Documentation lives under `docs/selfhost/`:
   - `docs/selfhost/README.md` (entry point, Docker-first, K8s reference-only)
   - `docs/selfhost/edge-contract.md` (proxy-agnostic `/media` contract)
   - `docs/selfhost/smoke-checklist.md` (deterministic manual checks)
2. Config validation extends `config_preflight` only; it must **not** attempt to detect the proxy.
3. `/media` edge contract is specified in terms of:
   - required routes (`/media/`, `/media/preview/`, and the auth subrequest endpoint),
   - required forwarded SigV4 headers (including optional session token header),
   - “signed host” invariants (INTERNAL_PROXY vs EXTERNAL_BROWSER),
   - no-leak logging guidance (do not log SigV4 headers).

## Implementation tasks (expected)

1. Docs (proxy-agnostic)
   - Add `docs/selfhost/README.md` and link it from `docs/installation/README.md`
     (and optionally root `README.md`).
   - Add `docs/selfhost/edge-contract.md` describing the `/media` contract:
     - routes + auth subrequest pattern,
     - SigV4 header propagation contract,
     - clear “Nginx is reference only”.
   - Add `docs/selfhost/smoke-checklist.md`:
     - explicit INTERNAL_PROXY vs EXTERNAL_BROWSER breakpoints,
     - expected outcomes and failure mapping.

2. Deterministic config preflight (no live inspection)
   - Extend `src/backend/core/management/commands/config_preflight.py`:
     - validate `AWS_S3_ENDPOINT_URL` (required) as absolute URL, no userinfo,
       scheme allowlist.
     - validate `AWS_S3_DOMAIN_REPLACE` (optional) as URL when set and document how
       it maps to EXTERNAL_BROWSER signing.
     - emit deterministic `errors[]` with `field`, `failure_class`,
       `next_action_hint` (no-leak).
     - emit `manual_checks[]` (or similar) that prints an edge-contract checklist.
   - Add failure classes in a stable `config.*` namespace and document them in
     `docs/failure-class-glossary.md`.

3. Tests
   - Extend `src/backend/core/tests/commands/test_config_preflight.py`:
     - new validation branches + failure classes,
     - at least one regression ensuring output remains deterministic (ordering).

## Verification (minimum)

- `make lint`
- `make test-back` (or at minimum pytest on `core/tests/commands/test_config_preflight.py`)
- `docker compose up -d` infra smoke (no full e2e required for this story)
- `python src/backend/manage.py config_preflight` output reviewed for determinism.

## Traceability (required)

- New run report:
  - `_bmad-output/implementation-artifacts/runs/<YYYYMMDD-HHMMSS>-2.1/report.md`
  - plus `commands.log`, `files-changed.txt`, `gates.md`
- Update:
  - `_bmad-output/implementation-artifacts/latest.txt`
  - `_bmad-output/implementation-artifacts/sprint-status.yaml` (2.1 → review → done)
  - Dev Agent Record in the story file (link the run report)

