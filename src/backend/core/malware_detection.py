"""Malware detection callbacks"""

import logging

from lasuite.malware_detection.enums import ReportStatus

from core.models import Item, ItemUploadStateChoices
from core.utils.no_leak import safe_str_hash

logger = logging.getLogger(__name__)
security_logger = logging.getLogger("drive.security")

_MALWARE_ERROR_INFO_ALLOWLIST = {"error_code"}


def _sanitize_error_info(error_info: dict | None) -> dict:
    if not error_info:
        return {}
    sanitized: dict = {}
    for key in _MALWARE_ERROR_INFO_ALLOWLIST:
        if key in error_info:
            sanitized[key] = error_info[key]
    return sanitized


def malware_detection_callback(file_path, status, error_info, **kwargs):
    """Malware detection callback"""

    file_key_hash = safe_str_hash(file_path)
    item_id = kwargs.get("item_id")
    try:
        item = Item.objects.get(pk=item_id)
    except Item.DoesNotExist:
        logger.info("Item %s does not exist anymore", item_id)
        return

    if status == ReportStatus.SAFE:
        logger.info(
            "File is safe (item_id=%s file_key_hash=%s)", item_id, file_key_hash
        )
        item.upload_state = ItemUploadStateChoices.READY
        item.save(update_fields=["upload_state"])
        return

    sanitized_error_info = _sanitize_error_info(error_info)
    error_code = sanitized_error_info.get("error_code")

    if status == ReportStatus.UNKNOWN:
        security_logger.warning(
            "File has unknown report status (item_id=%s file_key_hash=%s error_code=%s)",
            item_id,
            file_key_hash,
            error_code,
        )

        if error_code == 413:
            item.upload_state = ItemUploadStateChoices.FILE_TOO_LARGE_TO_ANALYZE
            item.save(update_fields=["upload_state"])
            return

    if status == ReportStatus.UNSAFE:
        security_logger.warning(
            "File is suspicious (item_id=%s file_key_hash=%s error_code=%s)",
            item_id,
            file_key_hash,
            error_code,
        )

    item.malware_detection_info = sanitized_error_info
    item.upload_state = ItemUploadStateChoices.SUSPICIOUS
    item.save(update_fields=["upload_state", "malware_detection_info"])
