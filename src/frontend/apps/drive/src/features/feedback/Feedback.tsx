import { Icon } from "@gouvfr-lasuite/ui-kit";
import {
  Button,
  ButtonProps,
  Modal,
  ModalSize,
  useModal,
} from "@openfun/cunningham-react";
import React, { useMemo } from "react";
import { useTranslation } from "react-i18next";
import { useConfig } from "../config/ConfigProvider";
import { useMessagesWidget } from "./useMessagesWidget";

export const Feedback = (props: { buttonProps?: Partial<ButtonProps> }) => {
  const { t } = useTranslation();
  const modal = useModal();
  const { config } = useConfig();
  const { showWidget } = useMessagesWidget();

  const FEEDBACK_BUTTONS = useMemo(() => {
    return config?.FRONTEND_FEEDBACK_ITEMS
      ? Object.entries(config.FRONTEND_FEEDBACK_ITEMS).map(([key, value]) => {
          let Icon: React.ReactElement;
          switch (key) {
            case "form":
              Icon = <FormIcon />;
              break;
            case "tchap":
              Icon = <TchapIcon />;
              break;
            case "visio":
              Icon = <VisioIcon />;
              break;
            default:
              Icon = <FormIcon />;
              break;
          }
          return {
            icon: Icon,
            title: `feedback.modal.buttons.${key}.title`,
            description: `feedback.modal.buttons.${key}.description`,
            href: value.url,
          };
        })
      : [];
  }, []);

  const showFeedbackButton = () => {
    if (!config?.FRONTEND_FEEDBACK_BUTTON_SHOW) {
      return false;
    }

    // For idle mode, there is no feedback buttons displayed as the modal will never show up,
    // so we show the button even if there is no href.
    if (
      !config?.FRONTEND_FEEDBACK_BUTTON_IDLE &&
      FEEDBACK_BUTTONS.filter((button) => !!button.href).length === 0
    ) {
      return false;
    }
    return true;
  };

  const onClick = () => {
    if (config?.FRONTEND_FEEDBACK_BUTTON_IDLE) {
      return;
    }
    if (config?.FRONTEND_FEEDBACK_MESSAGES_WIDGET_ENABLED) {
      showWidget();
      return;
    }
    modal.open();
  };

  if (!showFeedbackButton()) {
    return null;
  }

  return (
    <>
      <Button
        color="tertiary"
        icon={<Icon name="info" />}
        className="c__feedback__button"
        onClick={onClick}
        {...props.buttonProps}
      >
        {t("feedback.button")}
      </Button>
      <Modal
        {...modal}
        title={t("feedback.modal.title")}
        size={ModalSize.MEDIUM}
      >
        <p className="fs-m clr-greyscale-600">
          {t("feedback.modal.description")}
        </p>
        <div className="c__feedback__modal__buttons">
          {FEEDBACK_BUTTONS.filter((button) => !!button.href).map((button) => (
            <FeedbackButton
              key={button.title}
              {...button}
              href={button.href!}
            />
          ))}
        </div>
      </Modal>
    </>
  );
};

export const FeedbackFooterMobile = () => {
  return (
    <div className="c__feedback__footer">
      <Feedback buttonProps={{ fullWidth: true }} />
    </div>
  );
};

const FeedbackButton = (props: {
  icon: React.ReactElement;
  title: string;
  description: string;
  href: string;
}) => {
  const { t } = useTranslation();
  return (
    <a href={props.href} target="_blank" className="c__feedback__modal__button">
      <div className="c__feedback__modal__button__icon">{props.icon}</div>
      <div className="c__feedback__modal__button__content">
        <div className="c__feedback__modal__button__title">
          {t(props.title)}
        </div>
        <div className="c__feedback__modal__button__description">
          {t(props.description)}
        </div>
      </div>
    </a>
  );
};

export const FormIcon = () => {
  return (
    <svg
      width="42"
      height="42"
      viewBox="0 0 42 42"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M16.297 8.92893C15.8505 8.92893 15.5005 8.79702 15.2468 8.53321C14.9931 8.2694 14.8663 7.89905 14.8663 7.42217V5.82409C14.8663 5.3472 14.9931 4.97685 15.2468 4.71304C15.5005 4.44923 15.8505 4.31733 16.297 4.31733H17.682C17.7327 3.45487 18.0726 2.71925 18.7017 2.11045C19.3409 1.50166 20.1019 1.19727 20.9847 1.19727C21.8674 1.19727 22.6233 1.50166 23.2524 2.11045C23.8917 2.71925 24.2366 3.45487 24.2874 4.31733H25.6876C26.134 4.31733 26.4841 4.44923 26.7378 4.71304C26.9914 4.97685 27.1183 5.3472 27.1183 5.82409V7.42217C27.1183 7.89905 26.9914 8.2694 26.7378 8.53321C26.4841 8.79702 26.134 8.92893 25.6876 8.92893H16.297ZM20.9847 5.76321C21.3601 5.76321 21.6746 5.6313 21.9283 5.36749C22.182 5.10368 22.3088 4.79421 22.3088 4.43908C22.3088 4.06366 22.182 3.74912 21.9283 3.49546C21.6746 3.23165 21.3601 3.09974 20.9847 3.09974C20.6194 3.09974 20.3049 3.23165 20.041 3.49546C19.7874 3.74912 19.6605 4.06366 19.6605 4.43908C19.6605 4.79421 19.7874 5.10368 20.041 5.36749C20.3049 5.6313 20.6194 5.76321 20.9847 5.76321ZM12.903 38.0749C11.3302 38.0749 10.1482 37.6741 9.35674 36.8725C8.57546 36.0811 8.18481 34.8888 8.18481 33.2958V10.2226C8.18481 8.66004 8.56024 7.4729 9.31108 6.66118C10.0721 5.84945 11.2136 5.44359 12.7355 5.44359H13.1008C13.0907 5.50447 13.0856 5.57042 13.0856 5.64145C13.0856 5.70233 13.0856 5.76321 13.0856 5.82409V7.19387C13.0856 7.47797 13.1059 7.71134 13.1465 7.89398H12.7964C12.076 7.89398 11.5332 8.10706 11.1679 8.53321C10.8128 8.95937 10.6352 9.53265 10.6352 10.2531V33.2654C10.6352 34.0264 10.8381 34.6098 11.244 35.0157C11.6499 35.4215 12.2485 35.6245 13.0399 35.6245H28.9446C29.7361 35.6245 30.3296 35.4215 30.7253 35.0157C31.1312 34.6098 31.3341 34.0264 31.3341 33.2654V22.6724L33.7845 20.222V33.2958C33.7845 34.8888 33.3888 36.0811 32.5974 36.8725C31.8161 37.6741 30.6391 38.0749 29.0664 38.0749H12.903ZM31.3341 12.5817V10.2531C31.3341 9.53265 31.1515 8.95937 30.7862 8.53321C30.4311 8.10706 29.8984 7.89398 29.1881 7.89398H28.8229C28.8635 7.71134 28.8838 7.47797 28.8838 7.19387V5.82409C28.8838 5.76321 28.8838 5.70233 28.8838 5.64145C28.8838 5.57042 28.8787 5.50447 28.8685 5.44359H29.2338C30.7152 5.44359 31.8415 5.80887 32.6126 6.53942C33.3939 7.26997 33.7845 8.29984 33.7845 9.62904V10.1313C33.7135 10.2023 33.6425 10.2733 33.5715 10.3444C33.5004 10.4154 33.4294 10.4864 33.3584 10.5574L31.3341 12.5817ZM13.3139 16.478C13.3139 16.2141 13.4052 15.9909 13.5878 15.8083C13.7806 15.6155 14.0089 15.5191 14.2727 15.5191H27.7118C27.9249 15.5191 28.1075 15.5648 28.2597 15.6561L26.4942 17.4216H14.2727C14.0089 17.4216 13.7806 17.3303 13.5878 17.1476C13.4052 16.9548 13.3139 16.7316 13.3139 16.478ZM13.3139 21.8658C13.3139 21.6121 13.4052 21.394 13.5878 21.2113C13.7806 21.0287 14.0089 20.9374 14.2727 20.9374H22.9785L21.0912 22.8246H14.2727C14.0089 22.8246 13.7806 22.7333 13.5878 22.5507C13.4052 22.3579 13.3139 22.1296 13.3139 21.8658ZM14.2727 28.5168C14.0089 28.5168 13.7806 28.4255 13.5878 28.2429C13.4052 28.0501 13.3139 27.8269 13.3139 27.5732C13.3139 27.3094 13.4052 27.0862 13.5878 26.9035C13.7806 26.7209 14.0089 26.6296 14.2727 26.6296H16.3883C16.6521 26.6296 16.8753 26.7209 17.058 26.9035C17.2507 27.0862 17.3471 27.3094 17.3471 27.5732C17.3471 27.8269 17.2507 28.0501 17.058 28.2429C16.8753 28.4255 16.6521 28.5168 16.3883 28.5168H14.2727ZM36.8894 14.2102L34.7738 12.0794L35.9153 10.9379C36.169 10.6843 36.4632 10.5473 36.7981 10.527C37.143 10.5067 37.4373 10.6183 37.6808 10.8618L38.0461 11.2271C38.3099 11.4909 38.4418 11.7953 38.4418 12.1403C38.4418 12.4751 38.3048 12.7795 38.0309 13.0535L36.8894 14.2102ZM19.828 29.5365C19.6859 29.5974 19.554 29.5619 19.4323 29.43C19.3105 29.2981 19.2851 29.1662 19.3562 29.0343L20.8173 26.036L33.6171 13.2361L35.7631 15.3517L22.9328 28.1515L19.828 29.5365Z"
        fill="currentColor"
      />
    </svg>
  );
};

export const TchapIcon = () => {
  return (
    <svg
      width="42"
      height="43"
      viewBox="0 0 42 43"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M13.588 37.7378C13.0603 37.7378 12.6494 37.5603 12.3552 37.2051C12.0711 36.8602 11.929 36.3934 11.929 35.8049V31.8478H11.1985C9.68662 31.8478 8.41323 31.5789 7.37828 31.0411C6.34334 30.4932 5.55698 29.7018 5.01921 28.6668C4.49159 27.6319 4.22778 26.3686 4.22778 24.8771V13.2187C4.22778 11.7272 4.49159 10.4639 5.01921 9.42899C5.55698 8.39404 6.34334 7.60768 7.37828 7.06992C8.41323 6.522 9.68662 6.24805 11.1985 6.24805H30.8016C32.3134 6.24805 33.5868 6.522 34.6217 7.06992C35.6567 7.60768 36.438 8.39404 36.9656 9.42899C37.5034 10.4639 37.7722 11.7272 37.7722 13.2187V24.8771C37.7722 26.3686 37.5034 27.6319 36.9656 28.6668C36.438 29.7018 35.6567 30.4932 34.6217 31.0411C33.5868 31.5789 32.3134 31.8478 30.8016 31.8478H21.0305L15.7796 36.5202C15.323 36.9261 14.9375 37.2305 14.6229 37.4334C14.3084 37.6364 13.9634 37.7378 13.588 37.7378ZM14.212 34.9526L19.0823 30.1127C19.3664 29.8185 19.6404 29.6257 19.9042 29.5344C20.168 29.443 20.513 29.3974 20.9391 29.3974H30.8016C32.3337 29.3974 33.4701 29.0169 34.2108 28.2559C34.9515 27.4848 35.3218 26.3534 35.3218 24.8619V13.2187C35.3218 11.7373 34.9515 10.6161 34.2108 9.85514C33.4701 9.084 32.3337 8.69844 30.8016 8.69844H11.1985C9.65618 8.69844 8.5147 9.084 7.774 9.85514C7.04345 10.6161 6.67817 11.7373 6.67817 13.2187V24.8619C6.67817 26.3534 7.04345 27.4848 7.774 28.2559C8.5147 29.0169 9.65618 29.3974 11.1985 29.3974H13.0705C13.4865 29.3974 13.7807 29.4836 13.9532 29.6561C14.1257 29.8286 14.212 30.1229 14.212 30.5389V34.9526ZM13.1618 14.8472C12.9081 14.8472 12.6951 14.761 12.5226 14.5885C12.3602 14.416 12.2791 14.208 12.2791 13.9645C12.2791 13.721 12.3602 13.518 12.5226 13.3557C12.6951 13.1832 12.9081 13.097 13.1618 13.097H28.6404C28.894 13.097 29.102 13.1832 29.2644 13.3557C29.4369 13.518 29.5231 13.721 29.5231 13.9645C29.5231 14.208 29.4369 14.416 29.2644 14.5885C29.102 14.761 28.894 14.8472 28.6404 14.8472H13.1618ZM13.1618 19.7937C12.9081 19.7937 12.6951 19.7125 12.5226 19.5502C12.3602 19.3777 12.2791 19.1646 12.2791 18.9109C12.2791 18.6776 12.3602 18.4746 12.5226 18.3021C12.6951 18.1195 12.9081 18.0282 13.1618 18.0282H28.6404C28.894 18.0282 29.102 18.1195 29.2644 18.3021C29.4369 18.4746 29.5231 18.6776 29.5231 18.9109C29.5231 19.1646 29.4369 19.3777 29.2644 19.5502C29.102 19.7125 28.894 19.7937 28.6404 19.7937H13.1618ZM13.1618 24.7553C12.9081 24.7553 12.6951 24.6742 12.5226 24.5118C12.3602 24.3393 12.2791 24.1313 12.2791 23.8878C12.2791 23.6341 12.3602 23.4211 12.5226 23.2486C12.6951 23.0761 12.9081 22.9898 13.1618 22.9898H23.2221C23.4656 22.9898 23.6736 23.0761 23.8461 23.2486C24.0186 23.4211 24.1049 23.6341 24.1049 23.8878C24.1049 24.1313 24.0186 24.3393 23.8461 24.5118C23.6736 24.6742 23.4656 24.7553 23.2221 24.7553H13.1618Z"
        fill="currentColor"
      />
    </svg>
  );
};

export const VisioIcon = () => {
  return (
    <svg
      width="42"
      height="43"
      viewBox="0 0 42 43"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M14.1288 27.1205C13.8568 27.1205 13.6502 27.0399 13.5092 26.8787C13.3783 26.7074 13.3128 26.4908 13.3128 26.2289C13.3128 25.8562 13.4588 25.3676 13.751 24.7631C14.0431 24.1486 14.4814 23.5341 15.0656 22.9196C15.66 22.3051 16.4105 21.7913 17.3172 21.3783C18.2239 20.9552 19.2867 20.7436 20.5056 20.7436C21.7346 20.7436 22.7975 20.9552 23.694 21.3783C24.6007 21.7913 25.3512 22.3051 25.9456 22.9196C26.5399 23.5341 26.9832 24.1486 27.2754 24.7631C27.5675 25.3676 27.7136 25.8562 27.7136 26.2289C27.7136 26.4908 27.6431 26.7074 27.502 26.8787C27.3711 27.0399 27.1645 27.1205 26.8825 27.1205H14.1288ZM20.5056 19.6103C19.8407 19.6103 19.2363 19.439 18.6923 19.0965C18.1584 18.754 17.7302 18.2906 17.4079 17.7063C17.0855 17.1119 16.9243 16.442 16.9243 15.6965C16.9243 15.0014 17.0855 14.3617 17.4079 13.7774C17.7302 13.1931 18.1584 12.7297 18.6923 12.3872C19.2363 12.0346 19.8407 11.8583 20.5056 11.8583C21.1705 11.8583 21.7699 12.0346 22.3038 12.3872C22.8478 12.7297 23.281 13.1931 23.6034 13.7774C23.9257 14.3617 24.0869 15.0014 24.0869 15.6965C24.0869 16.442 23.9257 17.1119 23.6034 17.7063C23.281 18.2906 22.8478 18.754 22.3038 19.0965C21.7699 19.439 21.1705 19.6103 20.5056 19.6103ZM13.1465 38.1968C12.6227 38.1968 12.2147 38.0205 11.9226 37.6679C11.6405 37.3254 11.4994 36.862 11.4994 36.2777V32.3489H10.7741C9.27309 32.3489 8.0088 32.0819 6.98125 31.548C5.9537 31.004 5.17297 30.2182 4.63904 29.1907C4.1152 28.1631 3.85327 26.9089 3.85327 25.428V13.853C3.85327 12.3721 4.1152 11.1179 4.63904 10.0903C5.17297 9.06278 5.9537 8.28205 6.98125 7.74812C8.0088 7.20413 9.27309 6.93213 10.7741 6.93213H30.2371C31.7381 6.93213 33.0024 7.20413 34.03 7.74812C35.0575 8.28205 35.8332 9.06278 36.3571 10.0903C36.891 11.1179 37.158 12.3721 37.158 13.853V25.428C37.158 26.9089 36.891 28.1631 36.3571 29.1907C35.8332 30.2182 35.0575 31.004 34.03 31.548C33.0024 32.0819 31.7381 32.3489 30.2371 32.3489H20.5358L15.3225 36.9879C14.8692 37.3909 14.4864 37.6931 14.1741 37.8946C13.8618 38.0961 13.5193 38.1968 13.1465 38.1968ZM13.7661 35.4315L18.6016 30.6262C18.8837 30.3341 19.1557 30.1427 19.4176 30.052C19.6795 29.9613 20.0221 29.916 20.4452 29.916H30.2371C31.7583 29.916 32.8866 29.5382 33.622 28.7827C34.3574 28.017 34.7251 26.8938 34.7251 25.4129V13.853C34.7251 12.3822 34.3574 11.269 33.622 10.5134C32.8866 9.74782 31.7583 9.365 30.2371 9.365H10.7741C9.24287 9.365 8.10954 9.74782 7.37414 10.5134C6.64881 11.269 6.28615 12.3822 6.28615 13.853V25.4129C6.28615 26.8938 6.64881 28.017 7.37414 28.7827C8.10954 29.5382 9.24287 29.916 10.7741 29.916H12.6328C13.0458 29.916 13.338 30.0016 13.5092 30.1729C13.6805 30.3441 13.7661 30.6363 13.7661 31.0493V35.4315Z"
        fill="currentColor"
      />
    </svg>
  );
};
